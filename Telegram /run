from telegram.ext import ApplicationBuilder, CommandHandler
import requests
import os

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
RENDER_URL = os.getenv("RENDER_EXTERNAL_URL")  # ex: https://agent-fdj-open-source.onrender.com

async def run(update, context):
    await update.message.reply_text("⏳ Lancement du run complet...")

    try:
        r = requests.get(f"{RENDER_URL}/run", timeout=20)
        if r.status_code == 200:
            await update.message.reply_text("✅ Run exécuté avec succès !")
        else:
            await update.message.reply_text("⚠️ Run lancé, mais réponse inattendue.")
    except Exception as e:
        await update.message.reply_text(f"❌ Erreur : {str(e)}")


def start_bot():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("run", run))

    app.run_polling()
